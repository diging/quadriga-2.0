<html layout:decorate="~{layouts/main}">
<head>
<title>Quadriga 2.0</title>
<style>
.cy-container {
    display: flex;
    flex-wrap: wrap;
}

.cy {
    height: 500px;
    flex: 3.5;
    border: 2px solid;
}
</style>
<script th:src="@{/resources/notify/bootstrap-notify.min.js}"></script>
<link th:href="@{/resources/notify/animate.css}" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.1/cytoscape.min.js"></script>
<script type="text/javascript" th:inline="javascript">
	
	function showNotification(message, status, time){
    	$.notify('<i class="fas fa-exclamation-circle"></i>'+message, {
    		type: status,
    		offset: {
    			x: 50,
    			y: 90
    		},
    		timer: time,
    		animate: {
    			enter: 'animated fadeInRight',
    			exit: 'animated fadeOutRight'
    		},
    	});
    }
	
	function updateGraph(cy, nodes, edges) {
		let existingNodes = new Map();
		cy.nodes().forEach(function(node) {
			if (node.data('uri') && node.data('group') != 0) {
				existingNodes.set(node.data('uri'), node.data('id'));
			}
		});
		let filteredNodes = [];
		let mapping = new Map();
		nodes.forEach(function(node) {
			if (node.data.group == 0 || !node.data.uri || !existingNodes.has(node.data.uri)) {
				filteredNodes.push(node);
				cy.add({
					group: 'nodes',
					data: node.data
				});
			} else if (node.data.uri && existingNodes.has(node.data.uri)) {
				mapping.set(node.data.id, existingNodes.get(node.data.uri));
			}
		});
		
		edges.forEach(function(edge) {
			if (mapping.has(edge.data.source)) {
				edge.data.source = mapping.get(edge.data.source);
			}
			
			if (mapping.has(edge.data.target)) {
				edge.data.target = mapping.get(edge.data.target);
			}
			console.log(edge);
			cy.add({
				group: 'edges',
				data: edge.data
			});
		});
		
		var layout = cy.layout({
            name : 'cose',
            idealEdgeLength : 5,
        });

		layout.run();
	}
	
    $(function() {
        var cy = cytoscape({
            container : document.getElementById('cy'),
            elements : [[${elements}]],
            layout : {
                name : 'cose',
                idealEdgeLength : 5,
            },
            style : [
                    {
                        selector : 'node',
                        css : {
                            'background-color' : 'mapData(group, 0, 1, #E1CE7A, #FDD692)',
                            'border-color' : '#B98F88',
                            'border-width' : 1,
                            'font-family' : 'Raleway, sans-serif',
                            'font-size' : '12px',
                            'font-weight' : 'bold',
                            'color' : 'mapData(group, 0, 1, #666, #333)',
                            'label' : 'data(label)',
                            'width' : 'mapData(group, 0, 1, 40, 55)',
                            'height' : "mapData(group, 0, 1, 40, 55)",
                            'text-valign' : 'center'
                        }

                    }, {
                        selector : 'edge',
                        css : {
                            'width' : 1,
                            'line-color' : '#754F44',
                            'target-arrow-shape' : 'none'
                        }
                    } ]
        });
        
        cy.on('tap', 'node', function(event) {
        	var currentNode = event.target;
        	if (!currentNode.data('isVisited') && currentNode.data('group') != 0) {
        		var queryUri = currentNode.data('uri');
            	var connectedPredicates = currentNode.neighborhood('node[group = 0]');
            	var connectedNodes = connectedPredicates.neighborhood('node[group = 1][uri][uri != "' + queryUri + '"]');
            	var ignoreList = '';
            	connectedNodes.forEach(function(node) {
            		ignoreList += node.data('uri') + ',';
            	});
                $.ajax({
        			'url': [[@{/auth/collections/}]] + '[(${collection})]/graph?uri=' + queryUri + '&ignoreList=' + ignoreList,
        			'type': "GET",
        			'success': function(data) {
        				updateGraph(cy, data.nodes, data.edges);
        				currentNode.data('isVisited', true);
        			},
        			'error': function(data) {
        				showNotification("Error fetching the sub-graph", "danger", 10000);
        			}
        		});
        	}
        });
        
    });
</script>
</head>
<body>
    <div layout:fragment="content">
        <h1>[[${collectionName}]]</h1>
        <label>Search and Select Concept</label>
        <div class="col-md-12">
            <div class="input-group ${status.error ? 'has-error' : ''} col-md-12">
                <input type="text" id="searchbox" class="form-control" placeholder="Search Conceptpower...">
                <span class="input-group-btn">
                    <button class="btn btn-default" type="button" id="searchGo"><i class="fas fa-search"></i></button>
                </span>
            </div>
        </div>
        <div id="searchResults" class="list-group"></div>
        <div class="cy-container">
            <div id="cy" class="cy"></div>
        </div>
    </div>
</body>
</html>