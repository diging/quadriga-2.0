<html layout:decorate="~{layouts/main}">
<head>
<title>Quadriga 2.0</title>
<style>
.cy-container {
    display: flex;
    flex-wrap: wrap;
}

.cy {
    height: 500px;
    flex: 3.5
}

.cy-accordion {
    margin-left: 10px;
    flex: 1.5
}
</style>
<script src="https://code.jquery.com/jquery-2.1.3.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.1/cytoscape.min.js"></script>
<script type="text/javascript" th:inline="javascript">
	function updateGraph(cy, nodes, edges) {
		let existingNodes = new Map();
		cy.nodes().forEach(function(node) {
			if (node.data('uri') && node.data('group') != 0) {
				existingNodes.set(node.data('uri'), node.data('id'));
			}
		});
		let filteredNodes = [];
		let mapping = new Map();
		nodes.forEach(function(node) {
			if (node.data.group == 0 || !node.data.uri || !existingNodes.has(node.data.uri)) {
				filteredNodes.push(node);
				cy.add({
					group: 'nodes',
					data: node.data
				});
			} else if (node.data.uri && existingNodes.has(node.data.uri)) {
				mapping.set(node.data.id, existingNodes.get(node.data.uri));
			}
		});
		console.log(mapping);
		console.log(filteredNodes);
		
		edges.forEach(function(edge) {
			if (mapping.has(edge.data.source)) {
				edge.data.source = mapping.get(edge.data.source);
			}
			
			if (mapping.has(edge.data.target)) {
				edge.data.target = mapping.get(edge.data.target);
			}
			console.log(edge);
			cy.add({
				group: 'edges',
				data: edge.data
			});
		});
		
		var layout = cy.layout({
            name : 'cose',
            idealEdgeLength : 5,
        });

		layout.run();
	}
	
    $(function() {
        var cy = cytoscape({
            container : document.getElementById('cy'),
            elements : [[${elements}]],
            layout : {
                name : 'cose',
                idealEdgeLength : 5,
            },
            style : [
                    {
                        selector : 'node',
                        css : {
                            'background-color' : 'mapData(group, 0, 1, #E1CE7A, #FDD692)',
                            'border-color' : '#B98F88',
                            'border-width' : 1,
                            'font-family' : 'Raleway, sans-serif',
                            'font-size' : '12px',
                            'font-weight' : 'bold',
                            'color' : 'mapData(group, 0, 1, #666, #333)',
                            'label' : 'data(label)',
                            'width' : 'mapData(group, 0, 1, 40, 55)',
                            'height' : "mapData(group, 0, 1, 40, 55)",
                            'text-valign' : 'center'
                        }

                    }, {
                        selector : 'edge',
                        css : {
                            'width' : 1,
                            'line-color' : '#754F44',
                            'target-arrow-shape' : 'none'
                        }
                    } ]
        });
        
        cy.on('tap', 'node', function(event) {
        	var currentNode = event.target;
        	var connectedPredicates = currentNode.neighborhood('node[group = 0]');
        	var connectedNodes = connectedPredicates.neighborhood('node[group = 1][uri]');
        	var ignoreList = '';
        	connectedNodes.forEach(function(node) {
        		ignoreList += node.data('uri') + ',';
        	});
            const queryUri = currentNode.data('uri');
            $.ajax({
    			'url': [[@{/auth/collections/}]] + '[(${collection})]/graph?uri=' + queryUri + '&ignoreList=' + ignoreList,
    			'type': "GET",
    			'success': function(data) {
    				updateGraph(cy, data.nodes, data.edges);
    			},
    			'error': function(data) {
    				
    			}
    		});
        });
        
    });
</script>
</head>
<body>
    <div layout:fragment="content">
        <h1>Collection page</h1>
        <div class="cy-container">
            <div id="cy" class="cy"></div>
        </div>
</body>
</html>